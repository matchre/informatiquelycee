<!doctype html>
<!-- Auteur : David Roche @davR74130 -->
<html lang="fr">
	<head>
		<meta charset="utf-8">
		<title>Visualiser des données avec D3</title>
		<link rel="stylesheet" href="css/css/vendor/bootstrap.min.css">
		<link rel="stylesheet" href="css/css/flat-ui.min.css">
		<link rel="stylesheet" href="highlight/styles/tomorrow-night.css">
		<link rel="stylesheet" href="css/style.css">
		<script src="highlight/highlight.pack.js"></script>
		<script>hljs.initHighlightingOnLoad();</script>
    <script src="./css/js/vendor/jquery.min.js"></script>
    <script src="./css/js/flat-ui.min.js"></script>
		<script>
			  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

			  ga('create', 'UA-92673245-1', 'auto');
			  ga('send', 'pageview');
			</script>
	</head>
	<body>
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <span class="navbar-brand">Visualiser des données avec D3</span>
					<span class="navbar-brand">Activité 16</span>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Activités <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                  <li><a href="./d3_a1.html">Activité 1</a></li>
	              <li><a href="./d3_a2.html">Activité 2</a></li>
	              <li><a href="./d3_a3.html">Activité 3</a></li>
                  <li><a href="./d3_a4.html">Activité 4</a></li>
	              <li><a href="./d3_a5.html">Activité 5</a></li>
	              <li><a href="./d3_a6.html">Activité 6</a></li>
                  <li><a href="./d3_a7.html">Activité 7</a></li>
	              <li><a href="./d3_a8.html">Activité 8</a></li>
                  <li><a href="./d3_a9.html">Activité 9</a></li>
                  <li><a href="./d3_a10.html">Activité 10</a></li>
                  <li><a href="./d3_a11.html">Activité 11</a></li>
                  <li><a href="./d3_a12.html">Activité 12</a></li>
                  <li><a href="./d3_a13.html">Activité 13</a></li>
                  <li><a href="./d3_a14.html">Activité 14</a></li>
                  <li><a href="./d3_a15.html">Activité 15</a></li>
                  <li><a href="./d3_a17.html">Activité 17</a></li>
              </ul>
            </li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
              <li><a href="d3_a15.html"><span class="fui-triangle-left-large"></a></li>
                <li><a href="d3_a17.html"><span class="fui-triangle-right-large"></a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
    <div class="container act">
            <p>Dans cette activité, nous allons, une fois de plus, nous appuyer sur le site <a href="http://www.datavis.fr/index.php#d3js" target="_blank">http://www.datavis.fr/</a>, et plus particulièrement sur la partie du site consacrée aux cartes choroplèthes (lire <a href="https://fr.wikipedia.org/wiki/Carte_choropl%C3%A8the" target="_blank">l'article</a> Wikipédia sur les cartes choroplèthes).</p>
            <p>Nous allons réaliser une carte choroplèthes consacrée au nombre d'habitants par département. Plus le nombre d'habitants dans un département sera important, plus ce même département apparaitra foncé sur la carte.</p>
            <h4>À faire vous même 16.1</h4>
            <p>Commencez par télécharger le fichier <a href="asset/population.csv" target="_blank">population.csv</a> et analysez-le en l'ouvrant avec un éditeur de texte.</p>
            <p>Nous utiliserons aussi le fichier "departments.json" vu dans l'activité précédente.</p>
            <p>Attention : dans la suite de cette activité, les fichiers "population.csv" et "departments.json" devront être placés dans le même dossier que le fichier "script.js".</p>
            <hr>
             <h4>À faire vous même 16.2</h4>
            <p>Vous devez modifier votre fichier "index.html" puisque nous allons utiliser un fichier CSS</p>
            <p>
                index.html
            </p>
            <pre><code class="html">
&lt!DOCTYPE html&gt
&lthtml lang="fr"&gt
&lthead&gt
    &ltmeta charset="utf-8"&gt
    &lttitle&gtVisualiser des données avec D3&lt/title&gt
    &ltlink rel="stylesheet" href="couleurs.css"&gt
    &ltscript src="d3.min.js"&gt&lt/script&gt
&lt/head&gt
&ltbody&gt
&lt/body&gt
 &ltscript src="script.js"&gt&lt/script&gt
&lt/html&gt
            </code></pre>
            <p>Créez un fichier "couleurs.css" (ce fichier devra se trouver dans le même dossier sur "index.html" et "script.js").</p>
            <p>Voici le contenu de ce fichier "couleurs.css"</p>
            <p>couleurs.css</p>
            <pre><code class="css">
.Reds .q0-9{fill:rgb(255,245,240)}
.Reds .q1-9{fill:rgb(254,224,210)}
.Reds .q2-9{fill:rgb(252,187,161)}
.Reds .q3-9{fill:rgb(252,146,114)}
.Reds .q4-9{fill:rgb(251,106,74)}
.Reds .q5-9{fill:rgb(239,59,44)}
.Reds .q6-9{fill:rgb(203,24,29)}
.Reds .q7-9{fill:rgb(165,15,21)}
.Reds .q8-9{fill:rgb(103,0,13)}
            </code></pre>
            <p>
				script.js
			</p>
			<pre><code class="javascript">
var body=d3.select("body");
var svg=body.append("svg");
svg.attr({"width":"600px","height":"600px"});
svg.attr("class","Reds");
var path = d3.geo.path();
var projection = d3.geo.conicConformal()
    .center([2.454071, 46.279229])
    .scale(3000)
    .translate([300,300]);
path.projection(projection);
d3.json("departments.json", function(geoJSON) {
    var map=svg.selectAll("path").data(geoJSON.features)
    map.enter()
        .append("path")
        .attr("stroke","black")
        .attr('id', function(d) {return "d" + d.properties.CODE_DEPT;})
        .attr("d", path);
   d3.csv("population.csv", function(csv) {
			var quantile = d3.scale.quantile().domain([0, d3.max(csv, function(e) { return +e.POP; })]).range(d3.range(9));
			csv.forEach(function(e,i) {
    			d3.select("#d" + e.CODE_DEPT)
        			.attr("class", function(d) { return "q" + quantile(+e.POP) + "-9"; })
    		});
    });
});
            </code></pre>
            <p>Analysez et testez ce code</p>
            <hr>
            <p>Voici ce que vous devriez obtenir</p>
            <iframe src="./D3/16_2/index.html" width="830px" height="630px"></iframe>
            <p>Étudions cet exemple :</p>
            <p>Pour commencer, quelques idées générales avant d'entrer dans les détails du code :</p>
            <ul>
                <li>À chaque département est attribué un "id" (au sens CSS du terme) de la forme "d+numéro du département" ("d01" pour l'ain, "d02" pour l'aine....)</li>
                <li>Les départements sont classés dans des groupes (9 groupes) en fonction de leur population (groupe 0 : départements dont la population est comprise entre 0 et p1, groupe 1 : départements dont la population est comprise entre p1 et p2, groupe 2 : départements dont la population est comprise entre p2 et p3....</li>
                <li>En fonction de leur groupe, les départements se voient attribuer une classe (au sens CSS du terme): les départements appartenant au groupe 0 ont la classe "q0-9", les départements appartenant au groupe 1 ont la classe "q1-9"...</li>
                <li>Dans le fichier CSS nous avons un nuancier de couleur qui va du rouge très clair pour la classe "q0-9" ou rouge très foncé pour la classe "q8-9". En fonction de son groupe (et donc de sa classe) chaque département se voit attribuer une couleur qui peut aller du rouge très clair au rouge très foncé en fonction de son nombre d'habitants : nous avons donc bien réalisé une carte choroplèthe.</li>
            </ul>
            <p>Passons maintenant à l'analyse du code :</p>
            <p>Vu le contenu du fichier "couleurs.css" (<i>.Reds .q0-9...</i>), nous devons attribuer la classe "Reds" à la balise svg (<i>svg.attr("class","Reds");</i>), comme cela chaque "path" aura bien 2 classes, la classe "Reds" et la classe de son groupe (q0-9, q1-9...ou q8-9). Pourquoi avoir choisi cette structure pour le fichier "couleurs.css" ? Je ne me suis pas "amusé" à coder toutes les couleurs, j'ai utilisé une partie du fichier <a href="asset/nuancier.css">nuancier.css</a>. Analysons ce fichier</p>
            <p>voici une partie du fichier "nuancier.css" :</p>
            <img src="img/d3_a16_1.png" alt="nuancier.css"/>
            <p>ci-dessus nous avons une couleur "principale" dénommée "YlGn" (qui correspond à du vert) et différentes teintes ("q0-3", "q1-3"...). Que signifie le x dans q0-x ? Tout simplement le nombre de teintes nécessaires (dans notre exemple nous utilisons 9 teintes différentes, car nous avons 9 groupes, nous utilisons donc les classes se terminant par 9 ("q0-9", "q1-9"....). Si nous avions eu 5 groupes, nous aurions eu besoin de 5 teintes différentes, nous aurions alors utilisé les classe se terminant par 5 ("q0-5", "q1-5"....).</p>
            <p>Inutile de créer vos propres nuanciers de couleurs, "copier-coller" les parties qui vous intéressent à partir du contenu du fichier "nuancier.css".</p>
            <p>Ce fichier "nuancier.css" est directement issu du site <a href="https://github.com/mbostock/d3/tree/master/lib/colorbrewer">Color Brewer</a>.</p>
            <h4>À faire vous même 16.3</h4>
            <p>Faites les modifications nécessaires afin d'obtenir la même carte choroplèthe que dans le "À faire vous même 16.2" mais en utilisant une autre couleur que le rouge.</p>
            <hr>
            <p>Poursuivons l'étude du code du "À faire vous même 16.2" :</p>
            <p>Chose très importante à noter, le <i>d3.csv("population.csv", function(csv)...</i> se trouve à "l'intérieur" du <i>d3.json("departments.json", function(geoJSON)...</i></p>
            <p>La ligne <i>.attr('id', function(d) {return "d" + d.properties.CODE_DEPT;})</i> permet d'attribuer les "id" aux différents départements.</p>
            <p>La division des départements en différents groupes est faite grâce à la ligne suivante :</p>
            <pre><code class="javascript">
var quantile = d3.scale.quantile().domain([0, d3.max(csv, function(e) { return +e.POP; })]).range(d3.range(9));
            </code></pre>
            <p>Nous utilisons la méthode <i>scale.quantile()</i> de D3js. Le "domain" s'étend de 0 au nombre maximum d'habitants trouvé (utilisation de la méthode "max" : <i>d3.max(csv, function(e) { return +e.POP; })])</i> (le "+" du <i>+e.POP</i> permet de transformer la chaîne de caractères en nombre)). Le "range" est un tableau qui contient les chiffres de 0 à 8 (<i>d3.range(9)</i> est équivalent à [0,1,2,3,4,5,6,7,8]), chaque élément du tableau correspond à un groupe (nous obtenons donc bien 9 groupes).</p>
            <p>Le <i>csv.forEach</i> permet de parcourir l'ensemble des départements présents dans le fichier "population.csv" et d'attribuer une classe (de "q0-9" à "q8-9") à chaque "path" (chaque département sur la carte). Afin de ne pas avoir directement le nombre d'habitants, mais plutôt le groupe du département nous avons écrit <i>quantile(+e.POP)</i> à la place d'un simple <i>+e.POP</i>. Nous avons donc la concaténation suivante : "q"+numéro du groupe+"-9", ce qui correspond bien aux classes présentes dans le fichier "couleurs.css".</p>
            <br>
            <p>Il est possible d'ajouter une légende à notre carte choroplèthe</p>
            <h4>À faire vous même 16.4</h4>
            <p>En vous inspirant de ce qui a déjà été fait ci-dessus et des explications données sur le site <a href="http://www.datavis.fr/index.php?page=map-population" target="_blank">http://www.datavis.fr/</a>, ajoutez une légende à la carte.</p>
            <iframe src="./D3/16_4/index.html" width="830px" height="630px"></iframe>
            <hr>
            <h4>À faire vous même 16.5</h4>
            <p>Télécharger le fichier "dep74.xls" sur le site de l'<a href="http://www.insee.fr/fr/ppp/bases-de-donnees/recensement/populations-legales/departement.asp?dep=74" target="_blank">INSEE</a> (cliquez sur "Format xls, 85 ko")</p>
            <p>Étudiez ce fichier en l'ouvrant avec un tableur</p>
            <p>Récupérer (en faisant un "copier-coller") les données nécessaires afin de créer un fichier au format CSV qui vous permettra de produire une carte choroplèthe consacrée au nombre d'habitants par communes</p>
            <p>Créez un programme permettant d'obtenir ceci</p>
            <iframe src="./D3/16_5/index.html" width="830px" height="630px"></iframe>
            <hr>
            <p>Comme vous l'avez sans doute remarqué, la représentation ci-dessus n'est pas très pertinente : il y a énormément de communes en vert très clair. Cela vient du fait que dans le département il y a une "grosse" ville  (Annecy) et beaucoup de petites communes (moins de 5000 habitants). Toutes les communes de moins de 5000 habitants sont représentées en vert très clair (qu'elles aient 100 ou 4500 habitants) : cela vient du fait que nous avons une échelle qui va de 0 à 50000. Une des solutions serait de ne pas tenir compte d'Annecy comme cela, nous aurions une échelle qui irait de 0 à 30000. Autre solution, prendre une échelle "non linéaire" qui nous permettrait d'avoir plus de couleurs de 0 à 5000 habitants et moins de couleurs de 30000 à 50000 habitants. C'est ce que nous avons fait ci-dessous avec une échelle basée sur la fonction racine carrée.</p>
            <iframe src="./D3/16_5b/index.html" width="830px" height="630px"></iframe>
    </div>
	</body>
</html>
