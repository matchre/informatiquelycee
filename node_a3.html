<!doctype html>
<!-- Auteur : David Roche @davR74130 -->
<html lang="fr">
	<head>
		<meta charset="utf-8">
		<title>Programmer côté serveur : ExpressJS</title>
		<link rel="stylesheet" href="css/css/vendor/bootstrap.min.css">
		<link rel="stylesheet" href="css/css/flat-ui.min.css">
		<link rel="stylesheet" href="highlight/styles/tomorrow-night.css">
		<link rel="stylesheet" href="css/style.css">
		<script src="highlight/highlight.pack.js"></script>
		<script>hljs.initHighlightingOnLoad();</script>
    <script src="./css/js/vendor/jquery.min.js"></script>
    <script src="./css/js/flat-ui.min.js"></script>
		<script>
			  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

			  ga('create', 'UA-92673245-1', 'auto');
			  ga('send', 'pageview');
			</script>
	</head>
	<body>
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <span class="navbar-brand">Programmer côté serveur : ExpressJS</span>
					<span class="navbar-brand">Activité 3</span>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="dropdown">
              <a href="./Fixed Top Navbar Example for Bootstrap_files/Fixed Top Navbar Example for Bootstrap.html" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Activités <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <li><a href="./node_intro.html">Introduction</a></li>
                <li><a href="./node_a1.html">Activité 1</a></li>
                <li><a href="./node_a2.html">Activité 2</a></li>
                <li><a href="./node_a4.html">Activité 4</a></li>
                <li><a href="./node_a5.html">Activité 5</a></li>
								<li><a href="./node_a6.html">Activité 6</a></li>
	              <li><a href="./node_a7.html">Activité 7</a></li>
	              <li><a href="./node_a8.html">Activité 8</a></li>
								<li><a href="./node_a9.html">Activité 9</a></li>
	              <li><a href="./node_a10.html">Activité 10</a></li>
              </ul>
            </li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
						<li><a href="node_a2.html"><span class="fui-triangle-left-large"></a></li>
            <li><a href="node_a4.html"><span class="fui-triangle-right-large"></a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
    <div class="container act">
			<h4>À faire vous-même 3.1</h4>
			<p>Faites un copier-coller du dossier "express_00" et renommez-le en "express_a3_1" (Je ne préciserai plus cette opération par la suite, vous devrez la faire systématiquement quand je vous demanderai de "Créez une nouvelle application").</p>
			<p>Complétez les fichiers avec le code suivant :</p>
			<p>serveur.js</p>
			<pre><code class="javascript">
var express = require('express');
var app = express();
app.get('/', function (req, res) {
 res.sendFile(__dirname + '/html/index.html');
});
app.listen(8080);
			</code></pre>
			<p>index.html</p>
			<pre><code class="html">
&lt!doctype html&gt
&lthtml lang="fr"&gt
&lthead&gt
 &ltmeta charset="utf-8"&gt
 &lttitle&gtVoici mon site&lt/title&gt
&lt/head&gt
&ltbody&gt
 &lth1&gtHello World! Ceci est un titre&lt/h1&gt
 &ltp&gtCeci est un &ltstrong&gtparagraphe&lt/strong&gt&lt/p&gt
&lt/body&gt
&lt/html&gt
			</code></pre>
			<p>Ouvrez une console et placez-vous dans le dossier "express_a3_1". Lancez le serveur en tapant dans la console :</p>
			<pre><code>
node serveur.js
			</code></pre>
			<p>Ouvrez un navigateur et tapez dans la barre d'adresse : http://localhost:8080</p>
			<p>La page devrait s'afficher dans le navigateur</p>
			<hr>
			<p>Analyse du fichier serveur.js :</p>
			<pre><code class="javascript">
var express = require('express');
			</code></pre>
			<p>Nous commençons par « importer » le module express (indispensable à partir du moment où vous voulez utiliser express)</p>
			<pre><code class="javascript">
var app = express();
			</code></pre>
			<p>Nous créons un objet « générique » qui nous permettra de manipuler tous les outils fournis par express.</p>
			<pre><code class="javascript">
app.get('/', function (req, res) {
 res.sendFile(__dirname + '/html/index.html');
});
			</code></pre>
			<p>Cette ligne est fondamentale :</p>
			<p>Nous utilisons la méthode get de l'objet app. Cette méthode est très importante puisque c'est elle qui va permettre à notre serveur de répondre aux requêtes HTTP de type GET (ne pas hésiter à revoir le document sur les requêtes HTTP : <a href="reseau_a1.html" target="_blank">ici</a>).</p>
			<p>Cette méthode accepte deux paramètres : '/' et une fonction anonyme.</p>
			<p>Quand vous écrivez l'adresse d'un site, on peut distinguer 3 parties : http://www.monsite.fr/mondossier/</p>
			<ul>
				<li>http:// => le protocole</li>
				<li>www.monsite.fr => l'adresse du serveur</li>
				<li>/mondossier/ => un chemin (URL)</li>
			</ul>
			<p>Le premier paramètre de la méthode get correspond à la partie "chemin (URL)"</p>
			<p>Sur notre machine de « test» (client et serveur sur un même ordinateur), la fonction anonyme (2e paramètre de la méthode get) sera exécutée quand l'adresse suivante : http://localhost:8080/ (le / final n'étant pas obligatoire, cela revient à écrire :  http://localhost:8080)</p>
			<p>Attention : Avec express, cette URL (1er paramètre de la méthode GET) n'a pas besoin de correspondre à l'emplacement réel de la ressource sur le serveur. Si je reprends l'exemple ci-dessus (http://www.monsite.fr/mondossier/), il se peut tout à fait que le dossier mondossier n'existe pas réellement sur le serveur. Nous verrons un peu plus loin l’intérêt de ces URL "fantômes" (avec la technique REST).</p>
			<p>Étudions maintenant la fonction anonyme :</p>
			<pre><code class="javascript">
function (req, res) {
 res.sendfile(__dirname + '/html/index.html');
}
			</code></pre>
			<p>Comme avec le module http vu plus haut, nous avons ici affaire en une fonction callback ayant 2 paramètres : req et res (exactement la même signification que dans l'exemple du "À faire vous-même 1.2").</p>
			<p>Nous utilisons la méthode sendFile de l'objet res, qui, comme son nom l'indique permet de renvoyer le contenu d'un fichier dans le corps de la réponse HTTP. Cette méthode a pour paramètre le chemin du fichier à renvoyer.</p>
			<p>Comme vous pouvez le constater, nous utilisons la variable __dirname qui contient le chemin absolu du dossier courant (dossier contenant le fichier serveur.js). En fonction de la machine, ce chemin absolu vers le dossier courant sera différent,  d'où l’intérêt de __dirname.</p>
			<p>Avec "__dirname + '/html/index.html'", nous avons donc une concaténation entre le chemin absolu et le chemin du fichier à envoyer. C'est un peu compliqué, donc voici un exemple :</p>
			<p>Sur ma machine, le chemin absolu menant au fichier index.html est : /home/lycee/nodejs/express_a3_1/html/index.html. Le dossier "express_a3_1" contient aussi le fichier serveur.js, le chemin absolu menant au fichier serveur.js est donc : /home/lycee/nodejs/express_a3_1. Nous avons donc __dirname='/home/lycee/nodejs/express_a3_1'.</p>
			<p>En faisant la concaténation «__dirname +'/html/index.html'», j'obtiens bien le chemin absolu du fichier index.html.</p>
			<p>Imaginons maintenant que je copie le dossier nodejs (et son contenu) sur une autre machine. Sur cette autre machine, le chemin absolu qui mène au fichier serveur.js est : /siteinternet/apprendrenodejs/nodejs/express_a3_1, nous avons donc __dirname='/siteinternet/apprendrenodejs/nodejs/express_a3_1'. La concaténation «__dirname +'/html/index.html'» nous permet donc bien de retrouver le chemin absolu du fichier index.html sur cette nouvelle machine. Le changement de machine ne nécessite pas de modification du code.</p>
			<p>La dernière ligne : </p>
			<pre><code class="javascript">
app.listen(8080);
			</code></pre>
			<p>ne devrait pas vous poser de problème si vous avez bien compris l'exemple du "À faire vous-même 1.2").</p>
			<h4>À faire vous-même 3.2</h4>
			<p>Créez une nouvelle application</p>
			<p>Soit le fichier html suivant :</p>
			<p>maPage.html</p>
			<pre><code class="html">
&lt!doctype html&gt
&lthtml lang="fr"&gt
&lthead&gt
 &ltmeta charset="utf-8"&gt
 &lttitle&gtMa Page&lt/title&gt
&lt/head&gt
&ltbody&gt
 &lth1&gtCeci est ma Page&lt/h1&gt
&lt/body&gt
&lt/html&gt
			</code></pre>
			<p>Votre application devra renvoyer au client le contenu de la page html "maPage.html" quand l'utilisateur saisira l'url "http://localhost:8080/coucou" dans la barre de son navigateur (le système gérant le contenu du fichier "index.html" devra rester inchangé).</p>
			<hr>
		</div>
	</body>
</html>
