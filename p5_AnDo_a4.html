<!doctype html>
<!-- Auteur : David Roche @davR74130 -->
<html lang="fr">
	<head>
		<meta charset="utf-8">
		<title>p5js et les données</title>
		<link rel="stylesheet" href="css/css/vendor/bootstrap.min.css">
		<link rel="stylesheet" href="css/css/flat-ui.min.css">
		<link rel="stylesheet" href="css/style.css">
        <link rel="stylesheet" href="highlight/styles/tomorrow-night.css">
    <script src="highlight/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="./css/js/vendor/jquery.min.js"></script>
    <script src="./css/js/flat-ui.min.js"></script>
    <script src="libProc/processing.min.js"></script>
		<script>
			  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

			  ga('create', 'UA-92673245-1', 'auto');
			  ga('send', 'pageview');
			</script>
	</head>
	<body>
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <span class="navbar-brand">p5js et les données</span>
					<span class="navbar-brand">Activité 4</span>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="dropdown">
              <a href="./Fixed Top Navbar Example for Bootstrap_files/Fixed Top Navbar Example for Bootstrap.html" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Activités <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                <li><a href="./p5_AnDo_a1.html">Activité 1</a></li>
                <li><a href="./p5_AnDo_a2.html">Activité 2</a></li>
                  <li><a href="./p5_AnDo_a3.html">Activité 3</a></li>
              </ul>
            </li>
          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li><a href="p5_AnDo_a3.html"><span class="fui-triangle-left-large"></a></li>
          </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>
    <div class="container act">
        <p>Le geoJSON est un format (<a href="http://geojson.org/" target="_blank">http://geojson.org/</a>) qui permet d'encoder des données à "caractère géographiques". Voici ce que dit Wikipédia à propos de ce format :</p>
        <blockquote>GeoJSON (de l'anglais Geographic JSON, signifiant littéralement JSON géographique) est un format ouvert d'encodage d'ensemble de données géospatiales simples utilisant la norme JSON (JavaScript Object Notation). Il permet de décrire des données de type point, ligne, chaîne de caractères, polygone, ainsi que des ensembles et sous-ensembles de ces types de données et d'y ajouter des attributs d'information qui ne sont pas spatiale. Le format GeoJSON, contrairement à la majorité des standards de systèmes d'informations géographiques, n'est pas écrit par l'Open Geospatial Consortium, mais par un groupe de travail de développeurs au travers d'internet.</blockquote>
        <p>Comme indiqué dans Wikipédia, le geoJSON est avant tout du JSON et nous le traiterons comme tel.</p>
        <h4>À faire vous-même 4.1</h4>
        <p>Dans la barre d'adresse de votre navigateur, tapez l'adresse suivante :</p>
        <pre><code>
http://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson
        </code></pre>
        <p>Vous devriez obtenir quelque chose ressemblant à ceci :</p>
        <iframe src="http://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson" width="800px" height="300px"></iframe>
        <hr>
        <p>Le site "earthquake.usgs.gov", comme le site "http://openweathermap.org/", propose une API qui renvoie des données à partir d'une simple url. Le site "earthquake.usgs.gov" renvoie des données au format geoJSON (c'est donc du JSON), ces données contiennent des informations sur les tremblements de terre détectés dans le monde sur une période de 30 jours. Le site vous propose différentes options pour la requête, vous trouverez une description complète de ces options <a href="http://earthquake.usgs.gov/fdsnws/event/1/" target="_blank">ici</a></p>
        <h4>À faire vous-même 4.2</h4>
        <p>En vous aidant de la documentation présente sur le site <a href="http://earthquake.usgs.gov/fdsnws/event/1/" target="_blank">http://earthquake.usgs.gov</a>, écrivez une requête sous forme d'url qui permettra d'obtenir des données (au format geoJSON) sur les tremblements de terre, d'une magnitude supérieure à 5, ayant eu lieu ces 30 derniers jours partout dans le monde.</p>
        <p>Testez votre requête en la copiant dans la barre d'adresse de votre navigateur. Une fois les données obtenues, étudiez-les afin de comprendre la structure de ces données.</p>
        <hr>
        <p>Il est possible d'utiliser la bibliothèque Leaflet afin d'afficher une carte sur votre page web. Si vous ne connaissez pas encore leaflet, je vous invite à suivre cette <a href="leaflet_a1.html" target="_blank">série d'activités</a>.</p>
        <h4>À faire vous-même 4.3</h4>
        <p>Crée un nouvel exemple en modifiant les fichiers index.html, style.css et script.js comme suit :</p>
        <p>index.html</p>
        <pre><code class="html">
&lt!doctype html&gt
&lthtml lang="fr"&gt
&lthead&gt
&ltmeta charset="utf-8"&gt
&lttitle&gtLeaflet&lt/title&gt
&ltlink rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css"/&gt
&ltlink rel="stylesheet" href="style.css"/&gt
&ltscript src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.4.18/p5.min.js"&gt&lt/script&gt
&ltscript src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"&gt&lt/script&gt
&lt/head&gt
&ltbody&gt
 &ltdiv id="map"&gt&lt/div&gt
&lt/body&gt
&ltscript src="script.js"&gt&lt/script&gt
&lt/html&gt
        </code></pre>
        <p>style.css</p>
        <pre><code class="css">
#map {
  width: 800px;
  height: 600px;
}
        </code></pre>
        <p>script.js</p>
        <pre><code class="javascript">
var map;
function setup(){
    noCanvas();
    map = L.map('map');
    var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    var osmAttrib='Map data © OpenStreetMap contributors';
    var osm = new L.TileLayer(osmUrl, {attribution: osmAttrib});
    map.setView([47.0, 3.0], 6);
    map.addLayer(osm);
}
function draw(){
}
        </code></pre>
        <p>Vous devriez obtenir ceci :</p>
        <iframe src="p5_AnDo/p5_AnDo_a4_3/index.html" width="830px" height="630px"></iframe>
        <hr>
        <h4>À faire vous-même 4.4</h4>
        <p>En vous aidant de ce que vous avez vu sur leaflet et sur les données renvoyées par le site <a href="http://earthquake.usgs.gov" target="_blank">http://earthquake.usgs.gov</a>, créez une page web qui affichera une carte des séismes d'une magnitude supérieure ou égale à 6 (sur les 30 derniers jours). Chaque séisme sera représenté par un "marker". Un "pop-up" affichant les informations suivantes : lieu, date et heure du séisme et sa magnitude, devra être associé à chaque "marker" (si les notions de "marker" et de "pop-up" vous sont inconnues, n'hésitez pas à vous replonger dans les activités consacrées à <a href="leaflet_a1.html" target="_blank">leaflet</a>.</p>
        <p>N.B : le site <a href="http://earthquake.usgs.gov" target="_blank">http://earthquake.usgs.gov</a> renvoie les informations de "timestamp" directement en millisecondes, inutile de multiplier la valeur par 1000.</p>
        <p>ATTENTION : les coordonnées d'un point au format geoJSON sont données par le couple [longitude, latitude], alors que dans leaflet, les coordonnées d'un point sont données par le couple [latitude, longitude] !</p>
        <p>Vous devriez obtenir ceci</p>
        <iframe src="p5_AnDo/p5_AnDo_a4_4/index.html" width="830px" height="630px"></iframe>
        <hr>
        <p>Leaflet propose la méthode "geoJson" qui va permettre de traiter automatiquement l'ensemble des données contenues dans un fichier geoJSON.</p>
        <h4>À faire vous-même 4.5</h4>
        <p>Nous allons utiliser un fichier geoJSON contenant les contours (polygones), les noms et les codes de tous les départements français. Vous pouvez télécharger le fichier contenant ces informations <a href="./asset/departements.geojson" target="_blank">ici</a> (ces données proviennent de <a href="https://github.com/gregoiredavid/france-geojson" target="_blank">ce site</a>, l'auteur est Grégoire David).</p>
        <p>Créez un nouvel exemple et modifiez le fichier script.js comme suit (sans oublier de placer "departements.geojson" dans le même répertoire que le fichier "script.js")</p>
        <p>script.js</p>
        <pre><code class="javascript">
var map;
function setup(){
	noCanvas();
    gotData();
	map = L.map('map');
    var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    var osmAttrib='Map data © OpenStreetMap contributors';
    var osm = new L.TileLayer(osmUrl, {attribution: osmAttrib});
    map.setView([47.0, 3.0], 6);
    map.addLayer(osm);
}
function gotData(){
    loadJSON("departements.geojson",afficheData);
}
function afficheData(data){
    var geo=L.geoJson(data)
    geo.addTo(map);
}
function draw(){
}
        </code></pre>
        <p>Voici ce que vous devriez obtenir :</p>
        <iframe src="p5_AnDo/p5_AnDo_a4_5/index.html" width="830px" height="630px"></iframe>
        <hr>
        <p>L'utilisation de la méthode "geoJson" est très simple :</p>
        <ul>
            <li>"var geo=L.geoJson(data)" nous créons un objet "geo" à l'aide de la méthode "geojson". Cette méthode prend en paramètre les données que nous avons téléchargées depuis le fichier "departements.geojson".</li>
            <li>"geo.addTo(map);" permet d'afficher tous les polygones qui ont été générés automatiquement</li>
        </ul>
        <p>Pour l'instant, nous n'avons pas utilisé les informations "nom" et "code" présentes dans le fichier "departements.geojson". Il est possible d'utiliser ces données en ajoutant un argument à la méthode "geoJson" :</p>
        <h4>À faire vous-même 4.6</h4>
        <p>Créez un nouvel exemple et modifiez le fichier script.js comme suit (sans oublier de placer "departements.geojson" dans le même répertoire que le fichier "script.js")</p>
        <p>script.js</p>
        <pre><code class="javascript">
var map;
function setup(){
	noCanvas();
    gotData();
	map = L.map('map');
    var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    var osmAttrib='Map data © OpenStreetMap contributors';
    var osm = new L.TileLayer(osmUrl, {attribution: osmAttrib});
    map.setView([47.0, 3.0], 6);
    map.addLayer(osm);
}
function gotData(){
    loadJSON("departements.geojson",afficheData);
}
function afficheData(data){
    var geo=L.geoJson(data,{onEachFeature:affDep});
    geo.addTo(map);
}
function affDep(feature,layer){
    layer.bindPopup("&ltp&gtNom : "+feature.properties.nom+"&lt/p&gt&ltp&gtCode : "+feature.properties.code+"&lt/p&gt");
}
function draw(){
}
        </code></pre>
        <p>Voici ce que vous devriez obtenir (cliquez sur les départements) :</p>
        <iframe src="p5_AnDo/p5_AnDo_a4_6/index.html" width="830px" height="630px"></iframe>
        <hr>
        <p>Cet exemple est plus complexe et nécessite quelques explications :</p>
        <ul>
            <li>Nous avons ajouté un argument supplémentaire à la méthode "geoJson", cet argument ("{onEachFeature:affDep}") est un objet JavaScript qui contient l'attribut "onEachFeature" qui, en gros, signifie "pour chaque caractéristique" (dans l'exemple qui nous intéresse, cela signifie plus exactement, "pour chaque département"). Chaque fois que leaflet traite un nouveau département (en le dessinant sur la carte), il exécute la fonction "affDep".</li>
            <li>La fonction "affDep" prend 2 paramètres, "feature" et "layer". "layer" correspond au polygone du département qui est en cours de traitement (puisque la fonction "affDep" est appelée pour chaque département). "feature" correspond aux données geojson associées au département en cours de traitement. La fonction "affDep" contient une seule ligne : "layer.bindPopup("&ltp&gtNom : "+feature.properties.nom+"&lt/p&gt&ltp&gtCode : "+feature.properties.code+"&lt/p&gt");". Cette unique ligne permet d'associer un "pop-up" au département en cours de traitement. Une fois les données entièrement traitées, chaque département aura été associé à un "pop-up" qui affichera le nom et le code du département.</li>
        </ul>
        <p>Tout cela est un peu complexe, n'hésitez pas à demander des explications supplémentaires si nécessaire.</p>
        <p>L'objet JavaScript qui correspond au second paramètre de la méthode "geoJson" accepte d'autres attributs en plus de "onEachFeature" : "style", "filter",... Pour en savoir plus sur ces options, n'hésitez pas  consulter <a href="http://leafletjs.com/reference.html#geojson" target="_blank">la documentation officielle</a></p>
        <p>Si vous voulez créer vos propres fichiers geojson, il existe un outil en ligne très pratique et très intuitif : <a href="http://geojson.io/" target="_blank">http://geojson.io/</a></p>
    </div>
	</body>
</html>
